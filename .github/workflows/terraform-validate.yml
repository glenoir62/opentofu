name: Terraform Validate, Lint, Scan & Plan

on:
  push:
    branches:
      - main
      - staging
  pull_request:
    branches:
      - main
      - staging

permissions:
  id-token: write       # N√©cessaire pour l'authentification OIDC AWS
  contents: read        # N√©cessaire pour actions/checkout
  pull-requests: write  # Pour poster des commentaires sur les PR
  security-events: write # Pour upload des r√©sultats Trivy

jobs:
  validate-code:
    name: Validate Terraform Code
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::466850084367:role/GitHubActions-Terraform-Role-Projet1
          aws-region: eu-west-3

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: '1.8.8'

      - name: OpenTofu Init (Validation Mode)
        id: init
        run: tofu init -backend=false -input=false
        working-directory: ./project-aws

      - name: OpenTofu Format Check
        id: fmt
        run: tofu fmt -check -recursive -diff
        continue-on-error: true
        working-directory: ./project-aws

      - name: Auto-format if needed
        if: steps.fmt.outcome == 'failure'
        run: |
          tofu fmt -recursive
          echo "‚ö†Ô∏è Files were auto-formatted. Please commit these changes."
        working-directory: ./project-aws

      - name: OpenTofu Validate
        id: validate
        run: tofu validate
        working-directory: ./project-aws

      # TFLint (Linter)
      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.58.0

      - name: Init TFLint
        run: tflint --init
        working-directory: ./project-aws

      - name: Run TFLint
        run: tflint --recursive
        working-directory: ./project-aws
        continue-on-error: true

      # Trivy (Security Scan)
      - name: Run Trivy IaC scan
        uses: aquasecurity/trivy-action@0.30.0
        with:
          scan-type: "config"
          scan-ref: "./project-aws"
          format: "sarif"
          output: "trivy-results.sarif"
          exit-code: "0"
          severity: "CRITICAL,HIGH"
          ignore-unfixed: true

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

      # R√©sum√© des r√©sultats
      - name: Summary
        if: always()
        run: |
          echo "## üîç Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Init**: ${{ steps.init.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Format**: ${{ steps.fmt.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Validate**: ${{ steps.validate.outcome }}" >> $GITHUB_STEP_SUMMARY

  terraform_plan:
    name: Generate Terraform Plan
    runs-on: ubuntu-latest
    needs: validate-code
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::466850084367:role/GitHubActions-Terraform-Role-Projet1
          aws-region: eu-west-3

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: '1.8.8'

      - name: Determine Terraform workspace
        run: |
          if [ "${{ github.base_ref }}" = "main" ]; then
            WORKSPACE=prod
          elif [ "${{ github.base_ref }}" = "staging" ]; then
            WORKSPACE=dev
          else
            WORKSPACE=dev
          fi
          echo "WORKSPACE=$WORKSPACE" >> $GITHUB_ENV

      - name: OpenTofu Init (for plan)
        id: init_plan
        run: tofu init -input=false
        working-directory: ./project-aws

      - name: Select OpenTofu workspace
        run: |
          echo "Selecting workspace: $WORKSPACE"
          tofu workspace select $WORKSPACE || tofu workspace new $WORKSPACE
        working-directory: ./project-aws

      - name: OpenTofu Plan
        id: plan
        run: |
          echo "--- Running OpenTofu Plan ---"
          tofu plan -input=false -no-color -detailed-exitcode > plan.txt
          PLAN_COMMAND_RAW_EXIT_CODE=$?
          echo "OpenTofu Plan command raw exit code: $PLAN_COMMAND_RAW_EXIT_CODE"

          echo "--- Content of plan.txt ---"
          cat plan.txt
          echo "--- End of plan.txt ---"

          FINAL_PLAN_DETAILS="V√©rification manuelle du plan requise (analyse du contenu ou code de sortie non concluant)."

          if [ "$PLAN_COMMAND_RAW_EXIT_CODE" -eq 1 ]; then
            FINAL_PLAN_DETAILS="Erreur critique lors de la g√©n√©ration du plan (OpenTofu a retourn√© le code: $PLAN_COMMAND_RAW_EXIT_CODE)"
            echo "Condition: La commande OpenTofu Plan a directement signal√© une erreur."
          elif grep -q -E "(No changes\. Infrastructure is up-to-date\.|No changes\. Your infrastructure matches the configuration\.|Plan: 0 to add, 0 to change, 0 to destroy\.)" plan.txt; then
            FINAL_PLAN_DETAILS="aucun changement d√©tect√© (confirm√© par l'analyse du contenu du plan)"
            echo "Condition: Message explicite d'absence de changement trouv√© dans plan.txt."
          elif PLAN_SUMMARY_LINE=$(grep -E "^Plan: ([0-9]+ to add, [0-9]+ to change, [0-9]+ to destroy\.)$" plan.txt) && \
              (echo "$PLAN_SUMMARY_LINE" | grep -q -E "([1-9][0-9]* to add|[1-9][0-9]* to change|[1-9][0-9]* to destroy)") ; then
            ADD=$(echo "$PLAN_SUMMARY_LINE" | sed -n 's/^Plan: \([0-9]*\) to add,.*/\1/p')
            CHANGE=$(echo "$PLAN_SUMMARY_LINE" | sed -n 's/^Plan: [0-9]* to add, \([0-9]*\) to change,.*/\1/p')
            DESTROY=$(echo "$PLAN_SUMMARY_LINE" | sed -n 's/^Plan:.*, \([0-9]*\) to destroy.$/\1/p')
            FINAL_PLAN_DETAILS="changements d√©tect√©s (analyse du r√©sum√©: $ADD √† ajouter, $CHANGE √† modifier, $DESTROY √† d√©truire). Voir l'artefact."
            echo "Condition: Changements d√©tect√©s √† partir de la ligne de r√©sum√© de plan.txt."
          else
            echo "Warning: Contenu du plan ambigu pour la d√©tection automatis√©e des changements. Code de sortie brut: $PLAN_COMMAND_RAW_EXIT_CODE."
            if [ "$PLAN_COMMAND_RAW_EXIT_CODE" -eq 0 ] || [ "$PLAN_COMMAND_RAW_EXIT_CODE" -eq 2 ]; then
                FINAL_PLAN_DETAILS="Plan g√©n√©r√© (code: $PLAN_COMMAND_RAW_EXIT_CODE), mais contenu non analysable automatiquement. V√©rification manuelle requise."
            fi
          fi

          echo "PLAN_DETAILS=${FINAL_PLAN_DETAILS}" >> $GITHUB_OUTPUT
          echo "Final PLAN_DETAILS set to: ${FINAL_PLAN_DETAILS}"

          if [ "$PLAN_COMMAND_RAW_EXIT_CODE" -eq 1 ]; then
            exit 1
          fi
        working-directory: ./project-aws
        continue-on-error: true

      - name: Comment PR with plan output
        if: success() || failure()
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ### üìù R√©sultat du `tofu plan` pour le workspace `${{ env.WORKSPACE }}`

            ${{ steps.plan.outputs.PLAN_DETAILS }}

            Le plan complet est disponible en tant qu'artefact attach√© √† ce workflow.

            **Veuillez examiner attentivement le plan avant d'approuver cette PR.**

      - name: Upload OpenTofu plan artifact
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: opentofu-plan-${{ env.WORKSPACE }}
          path: ./project-aws/plan.txt
          retention-days: 7